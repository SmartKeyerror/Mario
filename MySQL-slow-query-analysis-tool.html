<!DOCTYPE html>
<html>
<head>
    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Page Meta -->
    <title>MySQL慢查询日志分析工具</title>
    <meta name="description" content="Keep coding, Keep curiosity" />

    <!-- Mobile Meta -->
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Brand icon -->
    <link rel="shortcut icon" href="/assets/images/favicon.ico" >

    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css" />

    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!-- Ghost outputs important style and meta data with this tag -->
        <link rel="canonical" href="https://smartkeyerror.com//MySQL-slow-query-analysis-tool" />
    <meta name="referrer" content="origin" />
    <link rel="next" href="/page2/" />

    <meta property="og:site_name" content="知其然, 知其所以然" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="MySQL慢查询日志分析工具" />
    <meta property="og:description" content="Keep coding, Keep curiosity" />
    <meta property="og:url" content="https://smartkeyerror.com//MySQL-slow-query-analysis-tool" />
    <meta property="og:image" content="/assets/images/cover1.jpg" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="MySQL慢查询日志分析工具" />
    <meta name="twitter:description" content="Keep coding, Keep curiosity" />
    <meta name="twitter:url" content="https://smartkeyerror.com//MySQL-slow-query-analysis-tool" />
    <meta name="twitter:image:src" content="/assets/images/cover1.jpg" />

    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Website",
    "publisher": "知其然, 知其所以然",
    "name": "MySQL慢查询日志分析工具",
    "url": "https://smartkeyerror.com//MySQL-slow-query-analysis-tool",
    "image": "/assets/images/cover1.jpg",
    "description": "Keep coding, Keep curiosity"
}
    </script>

    <meta name="generator" content="Jekyll 3.0.0" />
    <link rel="alternate" type="application/rss+xml" title="知其然, 知其所以然" href="/feed.xml" />


</head>
<body class="home-template nav-closed">

    <!-- The blog navigation links -->
    <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        <li class="nav-home " role="presentation"><a href="/">Home</a></li>
        <li class="nav-archives " role="presentation"><a href="/archives">Archives</a></li>
        <li class="nav-about " role="presentation"><a href="/about">About</a></li>
    </ul>
<!--    <a class="subscribe-button icon-feed" href="/feed.xml">Subscribe</a>-->
</div>
<span class="nav-cover"></span>


    <div class="site-wrapper">

        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The comment above "< default" means - insert everything in this file into -->
    <!-- the [body] of the default.hbs template, which contains our header/footer. -->

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<header class="main-header post-head no-cover">
    <nav class="main-nav  clearfix">
        
        
            <a class="menu-button icon-menu" href="#"><span class="word">Menu</span></a>
        
    </nav>
</header>

<main class="content" role="main">

    <article class="post tag-fiction">

        <header class="post-header">
            <h1 class="post-title">MySQL慢查询日志分析工具</h1>
            <section class="post-meta">
            <!-- <a href='/'></a> -->

            
                
                    <a href='/author/smartkeyerror'>smartkeyerror</a>
                
            
            <time class="post-date" datetime="2018-10-25">25 Oct 2018</time>
                <!-- [[tags prefix=" on "]] -->
                
                on
                
                    
                       <a href='/tag/MySQL'>MySQL</a>
                    
                
                
            </section>
        </header>

        <section class="post-content">

            <p>慢查询日志使我们对MySQL进行性能优化的关键指标， 只有在确定了哪些查询的确是慢查询之后才能对症下药， 进行性能优化， 而不是凭自身的感觉去判断， 结果有事往往出乎意料。 直接打开慢查询日志进行查看效率比较低效， 所以需要借助<code class="highlighter-rouge">pt-query-digest</code>工具来进行分析。</p>

<!---more--->

<h4 id="0-degine-mysql-version-57">0. Degine: MySQL Version: 5.7</h4>

<h4 id="1-percona-toolkit工具包的下载与安装">1. Percona Toolkit工具包的下载与安装</h4>
<p><code class="highlighter-rouge">Percona Toolkit</code>工具包包含了<code class="highlighter-rouge">pt-slave-delay</code>， <code class="highlighter-rouge">pt-query-digest</code>， <code class="highlighter-rouge">pt-mysql-summary</code>等非常有用的工具。</p>
<blockquote>
  <p>https://www.percona.com/downloads/percona-toolkit/LATEST/</p>
</blockquote>

<p>找对对应的版本以及平台进行安装即可。</p>

<h4 id="2-pt-query-digest的基本使用">2. pt-query-digest的基本使用</h4>
<p>首先来看一下分析的基本结果：</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pt-query-digest <span class="nt">--report</span> mysql-slow.log
</code></pre></div></div>
<p>核心输出结果如下：</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">#</span> <span class="k">Current</span> <span class="n">date</span><span class="p">:</span> <span class="n">Tue</span> <span class="n">Oct</span> <span class="mi">16</span> <span class="mi">11</span><span class="p">:</span><span class="mi">24</span><span class="p">:</span><span class="mi">55</span> <span class="mi">2018</span>
<span class="o">#</span> <span class="n">Hostname</span><span class="p">:</span> <span class="n">Zero</span>
<span class="o">#</span> <span class="n">Files</span><span class="p">:</span> <span class="n">mysql</span><span class="o">-</span><span class="n">slow</span><span class="p">.</span><span class="n">log</span>
<span class="o">#</span> <span class="n">Overall</span><span class="p">:</span> <span class="mi">7</span><span class="p">.</span><span class="mi">77</span><span class="n">k</span> <span class="n">total</span><span class="p">,</span> <span class="mi">94</span> <span class="k">unique</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="n">QPS</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">02</span><span class="n">x</span> <span class="n">concurrency</span> <span class="n">___________</span>
<span class="o">#</span> <span class="n">Time</span> <span class="n">range</span><span class="p">:</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">18</span> <span class="mi">14</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mi">31</span> <span class="k">to</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">16</span> <span class="mi">10</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mi">13</span>
<span class="o">#</span> <span class="n">Attribute</span>          <span class="n">total</span>     <span class="k">min</span>     <span class="k">max</span>     <span class="k">avg</span>     <span class="mi">95</span><span class="o">%</span>  <span class="n">stddev</span>  <span class="n">median</span>
<span class="o">#</span> <span class="o">============</span>     <span class="o">=======</span> <span class="o">=======</span> <span class="o">=======</span> <span class="o">=======</span> <span class="o">=======</span> <span class="o">=======</span> <span class="o">=======</span>
<span class="o">#</span> <span class="k">Exec</span> <span class="n">time</span>         <span class="mi">77201</span><span class="n">s</span>   <span class="mi">500</span><span class="n">ms</span>    <span class="mi">166</span><span class="n">s</span>     <span class="mi">10</span><span class="n">s</span>     <span class="mi">37</span><span class="n">s</span>     <span class="mi">15</span><span class="n">s</span>      <span class="mi">4</span><span class="n">s</span>
<span class="o">#</span> <span class="k">Lock</span> <span class="n">time</span>           <span class="mi">203</span><span class="n">s</span>       <span class="mi">0</span>     <span class="mi">22</span><span class="n">s</span>    <span class="mi">26</span><span class="n">ms</span>   <span class="mi">138</span><span class="n">us</span>   <span class="mi">500</span><span class="n">ms</span>    <span class="mi">73</span><span class="n">us</span>
<span class="o">#</span> <span class="k">Rows</span> <span class="n">sent</span>          <span class="mi">2</span><span class="p">.</span><span class="mi">46</span><span class="n">M</span>       <span class="mi">0</span>  <span class="mi">78</span><span class="p">.</span><span class="mi">34</span><span class="n">k</span>  <span class="mi">331</span><span class="p">.</span><span class="mi">51</span>  <span class="mi">511</span><span class="p">.</span><span class="mi">45</span>   <span class="mi">4</span><span class="p">.</span><span class="mi">37</span><span class="n">k</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">99</span>
<span class="o">#</span> <span class="k">Rows</span> <span class="n">examine</span>      <span class="mi">63</span><span class="p">.</span><span class="mi">82</span><span class="k">G</span>       <span class="mi">0</span>  <span class="mi">52</span><span class="p">.</span><span class="mi">93</span><span class="n">M</span>   <span class="mi">8</span><span class="p">.</span><span class="mi">41</span><span class="n">M</span>  <span class="mi">28</span><span class="p">.</span><span class="mi">56</span><span class="n">M</span>  <span class="mi">11</span><span class="p">.</span><span class="mi">25</span><span class="n">M</span>   <span class="mi">3</span><span class="p">.</span><span class="mi">68</span><span class="n">M</span>
<span class="o">#</span> <span class="n">Query</span> <span class="k">size</span>         <span class="mi">5</span><span class="p">.</span><span class="mi">06</span><span class="n">M</span>       <span class="mi">6</span>  <span class="mi">16</span><span class="p">.</span><span class="mi">48</span><span class="n">k</span>  <span class="mi">682</span><span class="p">.</span><span class="mi">18</span>   <span class="mi">2</span><span class="p">.</span><span class="mi">06</span><span class="n">k</span>  <span class="mi">724</span><span class="p">.</span><span class="mi">05</span>  <span class="mi">420</span><span class="p">.</span><span class="mi">77</span>
</code></pre></div></div>
<p>可以看到结果还是比较直观的， 包括执行时间， 加锁时间等， 横坐标中最有价值的信息为<code class="highlighter-rouge">95%</code>， 意义为将查询从小到大排列， 取位于整个排列的95%位置， 这样以来就会滤掉较大的值， 减少极值对统计的影响。 可以看到上面的输出<code class="highlighter-rouge">Exec time - 95% </code>输出结果为37s， 数值比较大， 所以完全有必要进行慢查询的优化。</p>

<p>继续来看输出：</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">#</span> <span class="n">Profile</span>
<span class="o">#</span> <span class="n">Rank</span> <span class="n">Query</span> <span class="n">ID</span>                      <span class="n">Response</span> <span class="n">time</span>    <span class="n">Calls</span> <span class="n">R</span><span class="o">/</span><span class="k">Call</span>  <span class="n">V</span><span class="o">/</span><span class="n">M</span>
<span class="o">#</span> <span class="o">====</span> <span class="o">=============================</span> <span class="o">================</span> <span class="o">=====</span> <span class="o">=======</span> <span class="o">=====</span>
<span class="o">#</span>    <span class="mi">1</span> <span class="mi">0</span><span class="n">x530A2CE72ED76F6FD03452E6</span><span class="p">...</span> <span class="mi">20003</span><span class="p">.</span><span class="mi">2369</span> <span class="mi">25</span><span class="p">.</span><span class="mi">9</span><span class="o">%</span>   <span class="mi">478</span> <span class="mi">41</span><span class="p">.</span><span class="mi">8478</span> <span class="mi">17</span><span class="p">.</span><span class="mi">77</span> <span class="k">SELECT</span> <span class="n">lv_pt_order</span> <span class="n">lv_pt_order_detail</span> <span class="n">lv_pt_goods</span> <span class="n">lv_user</span>
<span class="o">#</span>    <span class="mi">2</span> <span class="mi">0</span><span class="n">x1B1C071EBB0DECB4FCB8B4C9</span><span class="p">...</span> <span class="mi">19870</span><span class="p">.</span><span class="mi">1927</span> <span class="mi">25</span><span class="p">.</span><span class="mi">7</span><span class="o">%</span>   <span class="mi">855</span> <span class="mi">23</span><span class="p">.</span><span class="mi">2400</span>  <span class="mi">6</span><span class="p">.</span><span class="mi">26</span> <span class="k">SELECT</span> <span class="n">lv_pt_order</span> <span class="n">lv_pt_order_detail</span> <span class="n">lv_pt_goods</span> <span class="n">lv_user</span>
<span class="o">#</span>    <span class="mi">3</span> <span class="mi">0</span><span class="n">x84CAC95FCB28351DEB798161</span><span class="p">...</span>  <span class="mi">9187</span><span class="p">.</span><span class="mi">0368</span> <span class="mi">11</span><span class="p">.</span><span class="mi">9</span><span class="o">%</span>   <span class="mi">727</span> <span class="mi">12</span><span class="p">.</span><span class="mi">6369</span>  <span class="mi">8</span><span class="p">.</span><span class="mi">70</span> <span class="k">SELECT</span> <span class="n">lv_pt_order</span> <span class="n">lv_pt_order_detail</span> <span class="n">lv_pt_goods</span> <span class="n">lv_user</span>
<span class="o">#</span>    <span class="mi">4</span> <span class="mi">0</span><span class="n">x32D67A543AD02B4178806916</span><span class="p">...</span>  <span class="mi">6330</span><span class="p">.</span><span class="mi">5023</span>  <span class="mi">8</span><span class="p">.</span><span class="mi">2</span><span class="o">%</span>  <span class="mi">1545</span>  <span class="mi">4</span><span class="p">.</span><span class="mi">0974</span>  <span class="mi">5</span><span class="p">.</span><span class="mi">78</span> <span class="k">UPDATE</span> <span class="n">lv_session</span>
</code></pre></div></div>
<p>其中<code class="highlighter-rouge">Query ID</code>是每一个查询的哈希值指纹， <code class="highlighter-rouge">Response time</code>包括所有查询的返回时间以及占比， <code class="highlighter-rouge">Calls</code>为查询的次数， <code class="highlighter-rouge">R/Call</code>为该查询的平均时间， <code class="highlighter-rouge">V/M</code>为方差均值比， 表示该查询的返回时间波动性， 该值越大越有优化的价值。</p>

<p>再往下面就是对<code class="highlighter-rouge">Profile</code>中的每一条进行的详细分析。</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">#</span> <span class="n">Query</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="n">QPS</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="n">x</span> <span class="n">concurrency</span><span class="p">,</span> <span class="n">ID</span> <span class="mi">0</span><span class="n">x530A2CE72ED76F6FD03452E68015715F</span> <span class="k">at</span> <span class="n">byte</span> <span class="mi">6465751</span>
<span class="o">#</span> <span class="n">This</span> <span class="n">item</span> <span class="k">is</span> <span class="n">included</span> <span class="k">in</span> <span class="n">the</span> <span class="n">report</span> <span class="n">because</span> <span class="n">it</span> <span class="n">matches</span> <span class="c1">--limit.</span>
<span class="o">#</span> <span class="n">Scores</span><span class="p">:</span> <span class="n">V</span><span class="o">/</span><span class="n">M</span> <span class="o">=</span> <span class="mi">17</span><span class="p">.</span><span class="mi">77</span>
<span class="o">#</span> <span class="n">Time</span> <span class="n">range</span><span class="p">:</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">20</span> <span class="mi">18</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span><span class="mi">33</span> <span class="k">to</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">13</span> <span class="mi">00</span><span class="p">:</span><span class="mi">03</span><span class="p">:</span><span class="mi">20</span>
<span class="o">#</span> <span class="n">Attribute</span>    <span class="n">pct</span>   <span class="n">total</span>     <span class="k">min</span>     <span class="k">max</span>     <span class="k">avg</span>     <span class="mi">95</span><span class="o">%</span>  <span class="n">stddev</span>  <span class="n">median</span>
<span class="o">#</span> <span class="o">============</span> <span class="o">===</span> <span class="o">=======</span> <span class="o">=======</span> <span class="o">=======</span> <span class="o">=======</span> <span class="o">=======</span> <span class="o">=======</span> <span class="o">=======</span>
<span class="o">#</span> <span class="k">Count</span>          <span class="mi">6</span>     <span class="mi">478</span>
<span class="o">#</span> <span class="k">Exec</span> <span class="n">time</span>     <span class="mi">25</span>  <span class="mi">20003</span><span class="n">s</span>     <span class="mi">12</span><span class="n">s</span>    <span class="mi">166</span><span class="n">s</span>     <span class="mi">42</span><span class="n">s</span>     <span class="mi">97</span><span class="n">s</span>     <span class="mi">27</span><span class="n">s</span>     <span class="mi">32</span><span class="n">s</span>
<span class="o">#</span> <span class="k">Lock</span> <span class="n">time</span>      <span class="mi">0</span>    <span class="mi">86</span><span class="n">ms</span>    <span class="mi">58</span><span class="n">us</span>    <span class="mi">23</span><span class="n">ms</span>   <span class="mi">179</span><span class="n">us</span>   <span class="mi">144</span><span class="n">us</span>     <span class="mi">1</span><span class="n">ms</span>   <span class="mi">108</span><span class="n">us</span>
<span class="o">#</span> <span class="k">Rows</span> <span class="n">sent</span>      <span class="mi">0</span>   <span class="mi">8</span><span class="p">.</span><span class="mi">98</span><span class="n">k</span>      <span class="mi">10</span>      <span class="mi">20</span>   <span class="mi">19</span><span class="p">.</span><span class="mi">25</span>   <span class="mi">19</span><span class="p">.</span><span class="mi">46</span>    <span class="mi">2</span><span class="p">.</span><span class="mi">54</span>   <span class="mi">19</span><span class="p">.</span><span class="mi">46</span>
<span class="o">#</span> <span class="k">Rows</span> <span class="n">examine</span>  <span class="mi">24</span>  <span class="mi">15</span><span class="p">.</span><span class="mi">74</span><span class="k">G</span>  <span class="mi">24</span><span class="p">.</span><span class="mi">48</span><span class="n">M</span>  <span class="mi">52</span><span class="p">.</span><span class="mi">93</span><span class="n">M</span>  <span class="mi">33</span><span class="p">.</span><span class="mi">71</span><span class="n">M</span>  <span class="mi">51</span><span class="p">.</span><span class="mi">29</span><span class="n">M</span>  <span class="mi">10</span><span class="p">.</span><span class="mi">49</span><span class="n">M</span>  <span class="mi">27</span><span class="p">.</span><span class="mi">20</span><span class="n">M</span>
<span class="o">#</span> <span class="n">Query</span> <span class="k">size</span>     <span class="mi">3</span> <span class="mi">183</span><span class="p">.</span><span class="mi">98</span><span class="n">k</span>     <span class="mi">393</span>     <span class="mi">404</span>  <span class="mi">394</span><span class="p">.</span><span class="mi">14</span>  <span class="mi">400</span><span class="p">.</span><span class="mi">73</span>    <span class="mi">5</span><span class="p">.</span><span class="mi">50</span>  <span class="mi">381</span><span class="p">.</span><span class="mi">65</span>
<span class="o">#</span> <span class="n">String</span><span class="p">:</span>
<span class="o">#</span> <span class="n">Databases</span>    <span class="n">we8</span>
<span class="o">#</span> <span class="n">Hosts</span>
<span class="o">#</span> <span class="n">Users</span>        <span class="n">root</span>
<span class="o">#</span> <span class="n">Query_time</span> <span class="n">distribution</span>
<span class="o">#</span>   <span class="mi">1</span><span class="n">us</span>
<span class="o">#</span>  <span class="mi">10</span><span class="n">us</span>
<span class="o">#</span> <span class="mi">100</span><span class="n">us</span>
<span class="o">#</span>   <span class="mi">1</span><span class="n">mss</span>
<span class="o">#</span>  <span class="mi">10</span><span class="n">ms</span>
<span class="o">#</span> <span class="mi">100</span><span class="n">ms</span>
<span class="o">#</span>    <span class="mi">1</span><span class="n">s</span>
<span class="o">#</span>  <span class="mi">10</span><span class="n">s</span><span class="o">+</span>  <span class="o">################################################################</span>
<span class="o">#</span> <span class="n">Tables</span>
<span class="o">#</span>    <span class="k">SHOW</span> <span class="k">TABLE</span> <span class="n">STATUS</span> <span class="k">FROM</span> <span class="nv">`we8`</span> <span class="k">LIKE</span> <span class="s1">'lv_pt_order'</span><span class="err">\</span><span class="k">G</span>
<span class="o">#</span>    <span class="k">SHOW</span> <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`we8`</span><span class="p">.</span><span class="nv">`lv_pt_order`</span><span class="err">\</span><span class="k">G</span>
<span class="o">#</span>    <span class="k">SHOW</span> <span class="k">TABLE</span> <span class="n">STATUS</span> <span class="k">FROM</span> <span class="nv">`we8`</span> <span class="k">LIKE</span> <span class="s1">'lv_pt_order_detail'</span><span class="err">\</span><span class="k">G</span>
<span class="o">#</span>    <span class="k">SHOW</span> <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`we8`</span><span class="p">.</span><span class="nv">`lv_pt_order_detail`</span><span class="err">\</span><span class="k">G</span>
<span class="o">#</span>    <span class="k">SHOW</span> <span class="k">TABLE</span> <span class="n">STATUS</span> <span class="k">FROM</span> <span class="nv">`we8`</span> <span class="k">LIKE</span> <span class="s1">'lv_pt_goods'</span><span class="err">\</span><span class="k">G</span>
<span class="o">#</span>    <span class="k">SHOW</span> <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`we8`</span><span class="p">.</span><span class="nv">`lv_pt_goods`</span><span class="err">\</span><span class="k">G</span>
<span class="o">#</span>    <span class="k">SHOW</span> <span class="k">TABLE</span> <span class="n">STATUS</span> <span class="k">FROM</span> <span class="nv">`we8`</span> <span class="k">LIKE</span> <span class="s1">'lv_user'</span><span class="err">\</span><span class="k">G</span>
<span class="o">#</span>    <span class="k">SHOW</span> <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`we8`</span><span class="p">.</span><span class="nv">`lv_user`</span><span class="err">\</span><span class="k">G</span>
<span class="o">#</span> <span class="k">EXPLAIN</span> <span class="cm">/*!50100 PARTITIONS*/</span>
<span class="k">SELECT</span> <span class="nv">`o`</span><span class="p">.</span><span class="o">*</span><span class="p">,</span> <span class="nv">`od`</span><span class="p">.</span><span class="nv">`attr`</span><span class="p">,</span> <span class="nv">`od`</span><span class="p">.</span><span class="nv">`num`</span><span class="p">,</span> <span class="nv">`od`</span><span class="p">.</span><span class="nv">`pic`</span><span class="p">,</span> <span class="nv">`od`</span><span class="p">.</span><span class="nv">`goods_name`</span><span class="p">,</span> <span class="nv">`g`</span><span class="p">.</span><span class="nv">`name`</span> <span class="k">AS</span> <span class="nv">`goods_name`</span><span class="p">,</span> <span class="nv">`u`</span><span class="p">.</span><span class="nv">`nickname`</span> <span class="k">FROM</span> <span class="nv">`lv_pt_order`</span> <span class="nv">`o`</span> <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="nv">`lv_pt_order_detail`</span> <span class="nv">`od`</span> <span class="k">ON</span> <span class="n">od</span><span class="p">.</span><span class="n">order_id</span><span class="o">=</span><span class="n">o</span><span class="p">.</span><span class="n">id</span> <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="nv">`lv_pt_goods`</span> <span class="nv">`g`</span> <span class="k">ON</span> <span class="k">g</span><span class="p">.</span><span class="n">id</span><span class="o">=</span><span class="n">od</span><span class="p">.</span><span class="n">goods_id</span> <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="nv">`lv_user`</span> <span class="nv">`u`</span> <span class="k">ON</span> <span class="n">u</span><span class="p">.</span><span class="n">id</span><span class="o">=</span><span class="n">o</span><span class="p">.</span><span class="n">user_id</span> <span class="k">WHERE</span> <span class="p">((</span><span class="nv">`o`</span><span class="p">.</span><span class="nv">`is_delete`</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">AND</span> <span class="p">(</span><span class="nv">`o`</span><span class="p">.</span><span class="nv">`store_id`</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span> <span class="k">AND</span> <span class="p">(</span><span class="nv">`o`</span><span class="p">.</span><span class="nv">`is_cancel`</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="nv">`o`</span><span class="p">.</span><span class="nv">`addtime`</span> <span class="k">DESC</span> <span class="k">LIMIT</span> <span class="mi">20</span><span class="err">\</span><span class="k">G</span>
</code></pre></div></div>
<p>可以看到这条详细分析对应着<code class="highlighter-rouge">Profile</code>中的<code class="highlighter-rouge">Rank 1</code>, 其中<code class="highlighter-rouge">pct</code>即percentage， 表示该查询在该文件中的占比， 其余的基本大同小异。
在表格下方有一个直方图， 表示该查询的时间分布情况， 再往下就是实际的慢查询语句。
可以很直观的看到这条SQL语句的平均执行时间为42s， 最大查询时间166s,  总计执行了478次， 也算是颠覆了我对慢查询时间的认知， 我以为2s的查询就已经很糟糕了， 没想到这里竟然有100+s。</p>

<h4 id="3-pt-query-digest筛选参数">3. pt-query-digest筛选参数</h4>
<p>上面儿的内容基本上就是<code class="highlighter-rouge">pt-query-digest</code>所能够产生的结果， 另外可以添加一些参数来进行筛选。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 给出最近1个小时的慢查询分析结果</span>
pt-query-digest <span class="nt">--report</span> <span class="nt">--since</span> 3600s mysql-slow.log

<span class="c"># 给出一个时间区间的慢查询分析结果</span>
pt-query-digest <span class="nt">--report</span> <span class="nt">--since</span> <span class="s1">'2018-09-20 18:23:33'</span> <span class="nt">--until</span> <span class="s1">'2018-10-13 00:03:20'</span> mysql-slow.log

<span class="c"># 给出某个用户的所有慢查询， 在设计应用时， 前台和后台可以使用不同的MySQL账户</span>
pt-query-digest <span class="nt">--filter</span> <span class="s1">'($event-&gt;{user} || "") =~ m/^root/i'</span> mysql-slow.log
</code></pre></div></div>

<p>更多的内容请见官网。</p>

<blockquote>
  <p>https://www.percona.com/doc/percona-toolkit/LATEST/pt-query-digest.html#</p>
</blockquote>


        </section>

        <footer class="post-footer">

            <!-- Everything inside the #author tags pulls data from the author -->
            <!-- #author-->
            
                
                    
                        <figure class="author-image">
                            <a class="img" href="/author/smartkeyerror" style="background-image: url(/assets/images/author.png)"><span class="hidden">smartkeyerror's Picture</span></a>
                        </figure>
                    

                    <section class="author">
                        <h4><a href="/author/smartkeyerror">smartkeyerror</a></h4>

                        
                            <p> 日拱一卒，功不唐捐</p>
                        
                        <div class="author-meta">
                            <span class="author-location icon-location"> China</span>
                            <span class="author-link icon-link"><a href="https://smartkeyerror.com"> https://smartkeyerror.com</a></span>
                        </div>
                    </section>

                    <!-- /author  -->

                    <section class="share">
                        <h4>Share this post</h4>
                        <a class="icon-twitter" href="http://twitter.com/share?text=MySQL慢查询日志分析工具&amp;url=https://smartkeyerror.comMySQL-slow-query-analysis-tool"
                            onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                            <span class="hidden">Twitter</span>
                        </a>
                        <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://smartkeyerror.comMySQL-slow-query-analysis-tool"
                            onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                            <span class="hidden">Facebook</span>
                        </a>
                        <a class="icon-google-plus" href="https://plus.google.com/share?url=https://smartkeyerror.comMySQL-slow-query-analysis-tool"
                           onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                            <span class="hidden">Google+</span>
                        </a>
                    </section>
                
            

            <!-- Add Disqus Comments -->
            

        </footer>

    </article>

</main>

<aside class="read-next">

    <!-- [[! next_post ]] -->
    
        <a class="read-next-story no-cover" href="/MySQL-Permissions">
            <section class="post">
                <h2>MySQL权限管理</h2>
                <p>MySQL的权限管理重要性等同于服务器数据的重要性， 权限体系如果建立的不到位的话， 也就意味着生产数据处于危险状态。

</p>
            </section>
        </a>
    
    <!-- [[! /next_post ]] -->
    <!-- [[! prev_post ]] -->
    
        <a class="read-next-story prev no-cover" href="/MySQL-binlog">
            <section class="post">
                <h2>binlog的正确打开方式</h2>
                <p>在前面的主从复制中我们提到了bin-log， 主从复制中bing-log主要作为一种增量复制的方法进行主库与从库的同步。 在日常生产中， bin-log常常也作为实时数据恢复的必要手段。

</p>
            </section>
        </a>
    
    <!-- [[! /prev_post ]] -->
</aside>

<!-- /post -->


        <!-- The tiny footer at the very bottom -->
        <footer class="site-footer clearfix">
          <section class="copyright"><a href="/">知其然, 知其所以然</a> &copy; 2020</section>
          <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> using <a href="https://github.com/jekyller/jasper">Jasper</a></section>
        </footer>
    </div>
    <!-- highlight.js -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <!-- jQuery needs to come before `` so that jQuery can be used in code injection -->
    <script type="text/javascript" src="//code.jquery.com/jquery-1.12.0.min.js"></script>
    <!-- Ghost outputs important scripts and data with this tag -->
    <!--  -->
    <!-- Add Google Analytics  -->
        <!-- Google Analytics Tracking code -->
     <script>
	    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	    ga('create', 'UA-150652886-1', 'auto');
	    ga('send', 'pageview');

     </script>
    <!-- Fitvids makes video embeds responsive and awesome -->
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <!-- The main JavaScript file for Casper -->
    <script type="text/javascript" src="/assets/js/index.js"></script>

</body>
</html>
